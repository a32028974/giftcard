<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Voucher Regalo • Óptica Cristal</title>
<style>
  :root{
    --bg:#0b1220; --card:#121a2b; --text:#e8eefc; --muted:#9fb0d6; --accent:#7cc0ff;
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0; font:15px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
  .wrap{max-width:980px; margin:24px auto; padding:16px}
  .grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
  .card{background:var(--card); border:1px solid #1e2a42; border-radius:14px; padding:16px; box-shadow:0 8px 28px rgba(0,0,0,.28)}
  h1{margin:0 0 10px; font-size:22px}
  label{display:block; font-weight:600; margin:8px 0 4px}
  input, select{width:100%; padding:10px 12px; border:1px solid #1e2a42; border-radius:10px; background:#0f172a; color:var(--text)}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  button{cursor:pointer; padding:10px 14px; border-radius:10px; border:1px solid #1e2a42; background:#111827; color:#fff}
  button.primary{background:#0ea5e9; border-color:#0ea5e9; color:#031018; font-weight:700}
  button.ghost{background:transparent}
  .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
  .small{font-size:13px; color:var(--muted)}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .result{white-space:pre-wrap; background:#0f172a; border:1px solid #1e2a42; border-radius:10px; padding:10px; margin-top:10px}
  .scanbox{aspect-ratio: 1.6/1; border:1px dashed #2b3a5c; border-radius:12px; display:grid; place-items:center; color:#9fb0d6}
  .muted{color:var(--muted)}
  .flex{display:flex; align-items:center; gap:10px}
  .code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0b1328; border:1px solid #1f2b49; padding:2px 6px; border-radius:6px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }
</style>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Voucher Regalo – Óptica Cristal v4 </h1>
    <div class="grid">
      <!-- FORM -->
      <div class="card">
        <div class="row">
          <div>
            <label>Nombre</label>
            <input id="nombre" autocomplete="off" />
          </div>
          <div>
            <label>Apellido</label>
            <input id="apellido" autocomplete="off" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Importe (ARS)</label>
            <input id="importe" type="number" step="0.01" min="0" placeholder="0.00" />
          </div>
          <div>
            <label>Forma de pago</label>
            <select id="pago">
              <option value="">Elegí opción</option>
              <option>Efectivo</option>
              <option>Débito</option>
              <option>Crédito 1 cuota</option>
              <option>Crédito 3 cuotas</option>
              <option>Transferencia</option>
              <option>Otra</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Día de compra</label>
            <input id="fecha" type="date" />
          </div>
          <div>
            <label>Observación (opcional)</label>
            <input id="obs" placeholder="ej. solo armazón / promo / etc." />
          </div>
        </div>
        <div class="btns">
          <button class="primary" id="btnGuardarImprimir">Guardar & Imprimir</button>
          <button class="ghost" id="btnUltimo">Reimprimir último</button>
          <button id="btnEscanear">Escanear voucher</button>
          <span class="small">Se guarda en Google Sheets y en este dispositivo.</span>
        </div>
        <div id="msg" class="small" style="margin-top:8px"></div>
      </div>

      <!-- SCAN / RESULT -->
      <div class="card">
        <div class="flex" style="justify-content:space-between">
          <div class="flex">
            <strong>Consulta por código</strong>
            <input id="manualCode" placeholder="pegar/teclear código" style="width:220px" />
            <button id="btnBuscar">Buscar</button>
          </div>
          <div>
            <button id="btnToggleCam">Activar cámara</button>
          </div>
        </div>
        <div id="scanArea" class="scanbox" style="margin-top:10px">
          <span class="muted">Cámara apagada</span>
        </div>
        <div id="info" class="result" style="display:none"></div>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx47dayEhtFmx3WFT6-mZffcoMV5F6zCsKM1QtbdFWYj2SuHgyk53Kl0YchJFhn9ZcA/exec";
const VOUCHER_IMG     = "img/giftcard.jpg";  // asegurate que exista
const PRINT_W_MM = 150;  // 15 cm
const PRINT_H_MM = 100;  // 10 cm

/* ====== CACHE local ====== */
function loadDB(){ try{ return JSON.parse(localStorage.getItem("oc_vouchers")||"{}"); }catch(e){ return {}; } }
function saveDB(db){ localStorage.setItem("oc_vouchers", JSON.stringify(db)); }
function putLocal(id, data){ const db = loadDB(); db[id]=data; saveDB(db); }
function getLocal(id){ return loadDB()[id]; }
function setLast(id){ localStorage.setItem("oc_last_voucher", id); }
function getLast(){ return localStorage.getItem("oc_last_voucher"); }

/* ====== ID corto ====== */
function newId(){
  const d = Date.now().toString(36).toUpperCase();
  const r = Math.random().toString(36).slice(2,6).toUpperCase();
  return ("OC" + d + r).slice(0,14);
}

/* ====== BARCODE ====== */
function makeBarcodeSVG(id, options={}){
  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("xmlns","http://www.w3.org/2000/svg");
  const w = options.w || 1200, h = options.h || 220;
  svg.setAttribute("width", w); svg.setAttribute("height", h);
  JsBarcode(svg, id, {
    format:"CODE128",
    displayValue:false,
    margin:0,
    width: 2.2,      // grosor de barras
    height:h*0.78,
    lineColor:"#000"
  });
  return svg;
}

/* ====== IMPRESIÓN (iframe con IMG) ====== */
function printVoucher({id}){
  return new Promise((resolve)=>{
    const IMG_URL = new URL(VOUCHER_IMG, window.location.href).href;

    const iframe = document.createElement("iframe");
    iframe.style.position="fixed"; iframe.style.right="0"; iframe.style.bottom="0";
    iframe.style.width="0"; iframe.style.height="0"; iframe.style.border="0";
    document.body.appendChild(iframe);

    const doc = iframe.contentDocument;
    doc.open();
    doc.write(`<!DOCTYPE html>
<html><head><meta charset="utf-8" />
<style>
  @page{ size: ${PRINT_W_MM}mm ${PRINT_H_MM}mm; margin:0; }
  html,body{ height:100%; margin:0; }
  .sheet{ position:relative; overflow:hidden; width:${PRINT_W_MM}mm; height:${PRINT_H_MM}mm; background:#fff; }
  .bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
  .barcodeWrap{
    position:absolute; top:6mm; right:6mm;
    width:56mm; height:22mm;
    background:#fff; border-radius:2mm;
    display:flex; align-items:center; justify-content:center;
    padding:3mm; box-shadow:0 0 0 0.6mm #fff;
  }
  svg{ width:100%; height:100%; }
</style>
</head><body>
  <div class="sheet">
    <img id="bg" class="bg" src="${IMG_URL}" alt="Voucher" />
    <div class="barcodeWrap" id="barea"></div>
  </div>
</body></html>`);
    doc.close();

    const svg = makeBarcodeSVG(id, {w:1200, h:220});
    doc.getElementById("barea").appendChild(svg);

    const bg = doc.getElementById("bg");
    const doPrint = () => {
      setTimeout(()=>{
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
        setTimeout(()=>{ iframe.remove(); resolve(); }, 500);
      }, 200);
    };
    if (bg.complete) doPrint(); else { bg.onload = doPrint; bg.onerror = doPrint; }
  });
}

/* ====== UI ====== */
const $ = (id)=>document.getElementById(id);
const msg = (t, cls="")=>{ const el=$("msg"); el.textContent=t; el.className="small "+cls; };

$("btnGuardarImprimir").addEventListener("click", async ()=>{
  const nombre   = $("nombre").value.trim();
  const apellido = $("apellido").value.trim();
  const importe  = Number($("importe").value || 0);
  const pago     = $("pago").value.trim();
  const fecha    = $("fecha").value;
  const obs      = $("obs").value.trim();
  if(!nombre || !apellido || !pago || !fecha){
    msg("Completá nombre, apellido, forma de pago y fecha.", "warn"); return;
  }
  const id = newId();
  const data = { id, ts:Date.now(), nombre, apellido, importe, pago, fecha, obs };

  // Guardar en Google Sheets (sin CORS)
  try{
  const body = { action:"saveVoucher", payload:data };
  const params = new URLSearchParams();
  params.set('data', JSON.stringify(body));

  const res = await fetch(APPS_SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
    body: params.toString()
  });
    // lectura opcional (según deploy puede no devolver JSON)
    try{ const j = await res.json(); if(!j?.ok) console.warn("Sheets sin OK"); }catch(_){}
}catch(e){
  console.warn("No se pudo guardar en Sheets:", e);
}

  putLocal(id, data);
  setLast(id);
  msg(`Encontrado ${id}`, "ok");
  await printVoucher({id});
});

$("btnUltimo").addEventListener("click", ()=>{
  const id = getLast();
  if(!id){ msg("No hay último voucher para reimprimir.", "warn"); return; }
  printVoucher({id});
});

/* ====== BUSCAR ====== */
$("btnBuscar").addEventListener("click", ()=>{ const code = $("manualCode").value.trim(); if(code) showData(code); });

/* ====== ESCANEO ====== */
let camOn = false, qr;
async function toggleCam(){
  if(camOn){
    await qr?.stop(); qr?.clear(); camOn=false;
    $("scanArea").innerHTML = '<span class="muted">Cámara apagada</span>';
    $("btnToggleCam").textContent="Activar cámara";
    return;
  }
  $("scanArea").innerHTML = '<div id="reader" style="width:100%; height:100%"></div>';
  qr = new Html5Qrcode("reader");
  camOn=true; $("btnToggleCam").textContent="Apagar cámara";
  const onScan = (decodedText)=>{ if(decodedText){ showData(decodedText); } };
  const config = { fps: 10, qrbox: { width: 250, height: 150 }, formatsToSupport: [ Html5QrcodeSupportedFormats.CODE_128 ] };
  try{ await qr.start({ facingMode: "environment" }, config, onScan); }
  catch(e){ $("scanArea").innerHTML = '<span class="muted">No se pudo iniciar la cámara.</span>'; camOn=false; $("btnToggleCam").textContent="Activar cámara"; }
}
$("btnEscanear").addEventListener("click", toggleCam);
$("btnToggleCam").addEventListener("click", toggleCam);

/* ====== MOSTRAR DATOS ====== */
function fmtMoney(n){ return new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",minimumFractionDigits:2}).format(n||0); }
async function showData(id){
  let data = getLocal(id);
  if(!data){
    try{
      const url = new URL(APPS_SCRIPT_URL);
      url.searchParams.set('action','getVoucher');
      url.searchParams.set('id', id);
      const r = await fetch(url.toString());
      const j = await r.json();
      if(j?.ok && j.data){
        data = {
          id: j.data.id,
          fecha: j.data.fecha,
          nombre: j.data.nombre,
          apellido: j.data.apellido,
          importe: j.data.importe,
          pago: j.data.pago,
          obs: j.data.obs,
          ts: new Date(j.data.guardado).getTime()
        };
        putLocal(data.id, data);
      }
    }catch(_){}
  }
  if(data) renderData(data); else renderNotFound(id);
}
function renderData(d){
  const el = $("info"); el.style.display="block";
  el.innerHTML =
`Código: <span class="code">${d.id}</span>
Fecha compra: ${d.fecha}
Cliente: ${String(d.apellido||'').toUpperCase()}, ${String(d.nombre||'').toUpperCase()}
Importe: ${fmtMoney(d.importe)}
Forma de pago: ${d.pago}
Obs: ${d.obs || "-"}
Guardado: ${new Date(d.ts || Date.now()).toLocaleString("es-AR")}`;
  msg(`Encontrado ${d.id}`, "ok");
}
function renderNotFound(id){
  const el = $("info"); el.style.display="block";
  el.innerHTML = `No se encontró info para el código: <span class="code">${id}</span>`;
  msg("Sin resultados.", "err");
}

/* ====== UX ====== */
document.addEventListener("keydown", (e)=>{
  if(e.key==="Enter" && (document.activeElement.id==="manualCode")) $("btnBuscar").click();
});
</script>
</body>
</html>
