<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voucher Regalo – Óptica Cristal (QR)</title>
  <link rel="icon" href="logo.png" />
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#6b7280; --line:#e5e7eb; --brand:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text)}
    .wrap{max-width:980px; margin:24px auto; padding:0 16px}
    h1{font-weight:700; font-size:22px; margin:0}
    .muted{color:var(--muted)}
    .row{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:1px solid var(--line); border-radius:10px; background:#111827; color:#fff; cursor:pointer; font-weight:600}
    .btn.secondary{background:#fff; color:#111827}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; margin-top:16px}
    .field{display:grid; gap:6px; min-width:220px}
    label{font-size:14px; color:#111827; font-weight:600}
    input, select{height:40px; padding:8px 10px; border:1px solid var(--line); border-radius:8px; font-size:15px; background:#fff}
    .hint{font-size:13px; color:var(--muted)}
    .grid{display:grid; grid-template-columns:repeat( auto-fill, minmax(220px, 1fr) ); gap:14px}
    /* Vista previa de tarjetas */
    .cards{display:grid; grid-template-columns:repeat(auto-fill, minmax(240px, 1fr)); gap:16px; margin-top:16px}
    .card-voucher{border:1px dashed #d1d5db; border-radius:12px; padding:12px; background:#fff}
    .card-voucher h3{margin:0 0 8px; font-size:16px}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:14px; letter-spacing:.3px; color:#111827}
    .qr{display:flex; align-items:center; justify-content:center; width:160px; height:160px; margin:8px auto; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden; background:#fff}
    .bar{margin-top:16px; height:1px; background:linear-gradient(90deg,#e5e7eb 33%, transparent 0) 0/10px 1px repeat-x}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px}
    .pill{background:#eef2ff; color:#3730a3; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    @media print {
      body{background:#fff}
      .no-print{display:none !important}
      .cards{grid-template-columns:repeat(2, 1fr)} /* 2 por fila al imprimir */
      .card{border:0}
      .card-voucher{border:1px solid #000}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1> v2 Voucher Regalo – Óptica Cristal (QR)</h1>
        <div class="muted">Imprime tarjetas que apuntan a un “viewer” (App Script) donde se verá el regalo.</div>
      </div>
      <div class="actions no-print">
        <button class="btn secondary" id="btnAsignar">Vender / Asignar</button>
        <button class="btn" id="btnImprimirLote">Imprimir lote</button>
      </div>
    </div>

    <div class="card no-print">
      <div class="grid">
        <div class="field">
          <label for="cantidad">Cantidad de tarjetas</label>
          <select id="cantidad">
            <option>1</option><option>2</option><option>3</option><option>4</option><option selected>5</option>
            <option>10</option><option>20</option><option>30</option><option>50</option>
          </select>
        </div>
        <div class="field">
          <label for="prefijo">Prefijo (opcional)</label>
          <input id="prefijo" placeholder="OC" value="OC" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnGenerar">Generar vista previa</button>
        <div class="hint">Imprime tarjetas en blanco (QR al viewer del código).</div>
      </div>
    </div>

    <div id="preview" class="cards"></div>
  </div>

  <!-- QRCode.js (min) vía CDN. Si preferís, podés bajar el archivo y hostearlo local. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-6ZsJkz0rZlNw3t+5o4W7c1gX8mOe1mGvJH3k2tXbW7JQqYVfZ9n0TgK1qj8WmCw2rYz9u3Qx7Eo8Gz5x3GkG3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    // ====== CONFIG ======
    // URL del viewer (tu App Script que muestra el giftcard). Puse la que compartiste en el chat.
    // Si cambia, editá SOLAMENTE esta línea y listo.
    const VIEW_URL = 'https://script.google.com/macros/s/AKfycbyKV3I_UeCAP_YiMEvcSdBliqVvMgPr1zqRrsNflmy_oCd2nCKywyuEUjpb4mDucrRJ/exec';

    // ====== Helpers ======
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, attrs = {}, children = []) => {
      const n = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)) {
        if (k === 'class') n.className = v;
        else if (k === 'text') n.textContent = v;
        else n.setAttribute(k, v);
      }
      for (const c of [].concat(children)) n.appendChild(c);
      return n;
    };

    function todayStr() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2,'0');
      return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
    }

    function randomChunk(len=6) {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // sin 0/1/O/I
      let out = '';
      for (let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    function assertConfig() {
      const base = (VIEW_URL || '').trim();
      if (!base) throw new Error('Config: VIEW_URL vacío o no definido.');
      // validamos que sea absoluta o relativa resolvible
      try { new URL(base); } catch { new URL(base, window.location.href); }
    }

    // Construye de forma robusta la URL destino del QR
    function viewURLFor(code) {
      const base = (VIEW_URL || '').trim();
      if (!base) throw new Error('Config: VIEW_URL vacío o no definido');

      let u;
      try {
        // si es absoluta, entra acá
        u = new URL(base);
      } catch {
        // si es relativa (p.ej. "/viewer"), la resuelvo contra la URL actual
        u = new URL(base, window.location.href);
      }
      u.searchParams.set('code', (code || '').toString().trim());
      return u.toString();
    }

    function buildCodes(n, prefix='OC') {
      const date = todayStr();
      const out = [];
      for (let i=1; i<=n; i++) {
        const seq = String(i).padStart(3,'0');
        const chunk = randomChunk(6);
        const code = [prefix?.trim()||'OC', date, seq, chunk].filter(Boolean).join('-');
        out.push(code);
      }
      return out;
    }

    function makeCard(code) {
      const card = el('div', {class:'card-voucher'});
      card.appendChild(el('h3', {text:'Voucher Regalo • Óptica Cristal'}));
      card.appendChild(el('div', {class:'code', text: code}));

      const qrBox = el('div', {class:'qr'});
      card.appendChild(qrBox);

      // Genero el QR
      const targetUrl = viewURLFor(code);
      new QRCode(qrBox, {
        text: targetUrl,
        width: 160,
        height: 160,
        correctLevel: QRCode.CorrectLevel.M
      });

      const bar = el('div', {class:'bar'});
      card.appendChild(bar);
      const small = el('div', {class:'muted', text:'Escaneá el QR para ver el regalo disponible'});
      small.style.textAlign = 'center';
      small.style.marginTop = '8px';
      card.appendChild(small);

      return card;
    }

    function renderPreview(codes) {
      const cont = $('#preview');
      cont.innerHTML = '';
      codes.forEach(code => cont.appendChild(makeCard(code)));
    }

    function printPage() { window.print(); }

    // ====== Eventos ======
    $('#btnGenerar').addEventListener('click', () => {
      try {
        assertConfig();
        const n = parseInt($('#cantidad').value, 10) || 1;
        const prefix = $('#prefijo').value || 'OC';
        const codes = buildCodes(n, prefix);
        renderPreview(codes);
      } catch (e) {
        console.error(e);
        alert(e.message || 'Error al generar la vista previa');
      }
    });

    $('#btnImprimirLote').addEventListener('click', () => {
      try {
        // si no hay preview, lo genero rápido con los valores actuales
        if (!$('#preview').children.length) {
          const n = parseInt($('#cantidad').value, 10) || 1;
          const prefix = $('#prefijo').value || 'OC';
          const codes = buildCodes(n, prefix);
          renderPreview(codes);
        }
        assertConfig();
        printPage();
      } catch (e) {
        console.error(e);
        alert(e.message || 'No se pudo imprimir');
      }
    });

    $('#btnAsignar').addEventListener('click', () => {
      alert('Pantalla de “Vender / Asignar” pendiente (usa el mismo VIEW_URL para resolver por código).');
    });

    // Genero una vista previa inicial como en tu screenshot
    window.addEventListener('DOMContentLoaded', () => {
      try {
        const codes = buildCodes(5, 'OC');
        renderPreview(codes);
      } catch (e) {
        console.warn('Preview inicial omitida:', e.message);
      }
    });
  </script>
</body>
</html>
